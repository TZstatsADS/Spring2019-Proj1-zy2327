---
title: "How Background Affects Happiness"
author: "Zeyu Yang, zy2327"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

People with different background often have different sense of happiness. For example, a child may think of eating candies or visiting zoo as happy. A young person may think of being admitted by a dream university as happy. A middle-age person may view promotion as happy. Age along with other factors such as gender, parenthood and so on could greatly change the way people think of happiness. Thus, this data story is going to find out how background(age, gender and parenthood) affect happiness.


Here's a quick overview about the finding:

* All age groups mainly express feeling about positve, trust, joy and anticipation.

* Boyfriend and girlfriend are mentioned most by 10-20 age group; husband, wife, son and daughter are mentioned more in the rest age groups. Friend and family are the keywords to all age groups.

* "Father" tends to mentioned more about "work" while "mother" tends to mentioned more about family.

```{r install packages,echo=FALSE}
packages.used=c("data.table","tm","tidyverse","tidytext","tidyr", "grid","gridExtra", "lattice", "ngram")
# check packages that need to be installed.
packages.needed=setdiff(packages.used, 
                        intersect(installed.packages()[,1], 
                                  packages.used))
# install additional packages
if(length(packages.needed)>0){
  install.packages(packages.needed, dependencies = TRUE)
}
```


```{r Text Process,echo=FALSE,warning=FALSE,message=FALSE}
## This code chunk aims at processing the text

# Read data
library(data.table)
# urlfile<-'https://raw.githubusercontent.com/rit-public/HappyDB/master/happydb/data/cleaned_hm.csv'
hm_data <- fread("../data/cleaned_hm.csv")

# Lower the characters; remove numbers, punctuation,stop words & empty word
library(tm)
library(tidyverse)
my.stopwords <- c("happy","ago","yesterday","lot","today","months","month","happier","happiest","last","week","past","evening","night","day","time","hours","morning")
corpus <- VCorpus(VectorSource(hm_data$cleaned_hm))%>%
  tm_map(content_transformer(tolower))%>%
  tm_map(removeNumbers)%>%
  tm_map(removePunctuation)%>%
  tm_map(removeWords,stopwords("en"))%>%
  tm_map(removeWords,my.stopwords)%>%
  tm_map(removeWords,character(0))%>%
  tm_map(stripWhitespace)%>%
  tm_map(stemDocument)


# Tidy the text
library(tidytext)
ti <- tidy(corpus)%>% 
  select(text)%>%
  mutate(id=row_number())%>% # Add row number to track each sentence
  unnest_tokens(tokenized,text)

data <- ti%>%
  group_by(id)%>%
  summarise(text = str_c(tokenized,collapse = " "))%>%
  ungroup()

hm_data <- hm_data%>%
  mutate(id=row_number())%>%
  inner_join(data,by="id")%>%
  select(wid,cleaned_hm,predicted_category,text)

# Inner join demographic data
# urlfile<-'https://raw.githubusercontent.com/rit-public/HappyDB/master/happydb/data/demographic.csv'
demo_data <- fread("../data/demographic.csv")

hm_data <- hm_data%>%
  inner_join(demo_data,by="wid")%>%
  select(wid,cleaned_hm,text,age,country,gender,marital,parenthood)%>%
  filter(gender %in% c("m", "f")) %>%
  filter(marital %in% c("single", "married")) %>%
  filter(parenthood %in% c("n", "y"))

bag_of_words <-  hm_data %>%
  unnest_tokens(word, text)
```

# Age

Let's first take a look at the distribution of age.

```{r echo=FALSE, warning=FALSE}
hm_data %>% .$age %>% as.numeric() %>% na.omit() %>% hist(xlim=c(0,100),main="Histogram of age",xlab="age")
```

There are a great proportion of people aged 20-40. I am going to divide all the people into 5 groups: aged 10-20, 21-30, 31-40, 41-50 and 51-100. $*^1$ 

## Sentimental Analysis

__Sentimental Score:__

Sentiment score is a measurement of how positive or negative the words are. By computing the mean sentiment score of each sentence, we can see how positive/happy people are.

```{r echo=FALSE,warning=FALSE,message=FALSE}
# Sentiment score
library(tidyr)
sentiment_score <- bag_of_words%>%
  inner_join(get_sentiments("afinn"),by="word")%>%
  group_by(wid)%>%
  summarise(score=mean(score))%>%
  ungroup()%>%
  inner_join(demo_data,by="wid")%>%
  select(wid,score,age,country,gender,marital,parenthood)%>%
  filter(gender %in% c("m", "f")) %>%
  filter(marital %in% c("single", "married")) %>%
  filter(parenthood %in% c("n", "y"))

# Convert age into numerical value
setDT(sentiment_score)
sentiment_score <- transform(sentiment_score, age = as.numeric(age))
sentiment_score <- sentiment_score[! is.na(sentiment_score$age)]

# Divide the data into 5 age groups
sentiment_score <- sentiment_score%>%
  mutate(age_group = case_when(
    age>10 & age<=20 ~ "10-20",
    age>20 & age<=30 ~ "20-30",
    age>30 & age<=40 ~ "30-40",
    age>40 & age<=50 ~ "40-50",
    age>50 & age<=100 ~ "50-100"
  ))

sentiment_score <- sentiment_score[! is.na(sentiment_score$age_group),]

sentiment_score$age_group <- factor(sentiment_score$age_group,levels=c("10-20","20-30","30-40","40-50","50-100"))

# Draw the plot
ggplot()+
  geom_boxplot(data=sentiment_score,mapping=aes(x=age_group,y=score))+
  ggtitle("Sentiment score of different age groups")+
  theme(plot.title = element_text(hjust = 0.5))
```

From the above plot, we can see that the range and median of the sentiment score of different age groups are almost the same. It show that they have similar happy level.

The negative dots shown in the plot is due to the limit of this method. The sentiment score can only show the emotional strength of individual words instead of the whole sentence: it can not understand negative sentence. 



__Sentiment Category__

This part is grouping words into 10 segments: anger, anticipation, disgust, fear, joy, neagtive, positive, sadness, suprise and trust. Instead of measuring how strong the feeling of words are, it tries to find out what feelings different words express.

```{r echo=FALSE,warning=FALSE,message=FALSE}
# Sentiment category
sentiment_category <- bag_of_words%>%
  inner_join(get_sentiments("nrc"),by="word")%>%
  mutate(age_group = case_when(
    age>10 & age<=20 ~ "10-20",
    age>20 & age<=30 ~ "20-30",
    age>30 & age<=40 ~ "30-40",
    age>40 & age<=50 ~ "40-50",
    age>50 & age<=99 ~ "50-100"
  ))

# Remove na data
setDT(sentiment_category)
sentiment_category <- sentiment_category[! is.na(sentiment_category$age_group)]

# Group by age group and sentiment 
s_c <- sentiment_category[,.N,by=.(age_group,sentiment)]

# Change counting into percentage
s_c2 <- s_c %>% 
  group_by(age_group) %>% 
  summarise(count=sum(N)) %>% 
  ungroup()%>%
  inner_join(s_c)%>%
  mutate(perc=N/count)


ggplot(s_c2, aes(x = factor(age_group), y = perc*100, fill = factor(sentiment))) +
  geom_bar(stat="identity", width = 0.7)+
  labs(x = "age group", y = "Percentage", fill = "Sentiment Category")+
  ggtitle("Percentage of sentiment category of different age groups")+
  theme(plot.title = element_text(hjust = 0.5))
```


From the above plot, we can see the sentences mainly express feeling about positve, trust, joy and anticipation.


## Topics

In this part, we going to find out what relation/verb/objects that people mentioned most. $*^2$


__Relation__


```{r echo=FALSE,warning=FALSE,message=FALSE}
# Change age column into numerical and remove na data
setDT(bag_of_words)
bag_of_words <- transform(bag_of_words, age = as.numeric(age))
bag_of_words <- bag_of_words[! is.na(bag_of_words$age)]

# define the "person" vector, select top 10 mentioned word from each age group
person <- c("friend","girlfriend","family","people","boyfriend","sister","mom","dad","girl","brother","couple","parents","students","cousin","boy","husband","wife","daughter","son","granddaughter","grandson","kids","baby")

# This is a plot-drawing function. Parameter "i" refers to the i-th age group, "aspect" expects a vector that contains the words you try to find
g1.fun <- function(i,aspect)
{
  age.lower <- c(10,20,30,40,50)[i]
  age.upper <- c(20,30,40,50,100)[i]
  temp <- bag_of_words[age >age.lower & age <=age.upper,.N,by = .(word)][order(-N)][word %in% aspect][1:10]
  temp$word <- factor(temp$word,levels=temp$word[seq(10,1,-1)])
  t <- paste(age.lower,"-",age.upper)
  color = c("#ADD8E6","#87CEEB","#6495ED","#4169E1","#0000CD","#000080")
  g <- ggplot()+
  geom_bar(data=data.frame(temp),mapping=aes(word,N),stat = "identity",fill=color[i])+
  ggtitle(t)+
  coord_flip()
  return(g)
}


library(grid)
library(gridExtra)
library(lattice)
grid.arrange(g1.fun(1,person),g1.fun(2,person),g1.fun(3,person),g1.fun(4,person),g1.fun(5,person), nrow = 3,top="Mentioned relation by age group")
```

From the above plot, we can see that "friend" is the word that mentioned most among all age groups. It shows that friends are crucial to happiness.

Not suprisingly, boyfriend and girlfriend are top mentioned words for 10-20 age group. As age increases, top mentioned words are husband and wife, son and daughter, gandson and granddaughter.


__Verb__

```{r echo=FALSE,warning=FALSE,message=FALSE}
verb <- c("played","feel","enjoyed","finished","found","bought","watched","received","talked","started","passed","eat","completed","learned","told","spend","buy","called","planted","won","helped","cleaned","meet","pay","cooked","attended","read","shopping","run","celebrated")

grid.arrange(g1.fun(1,verb),g1.fun(2,verb),g1.fun(3,verb),g1.fun(4,verb),g1.fun(5,verb), nrow = 3,top="Mentioned verb by age group")
```

The top mentioned verbs among all age groups are "feel", "found", "bought". "Eat" has also been mentioned a lot. I personally agree with this one as well since eating is quiting relieving.


__About Objects__

```{r echo=FALSE,warning=FALSE,message=FALSE}
object <- c("dog","school","game","college","class","moment","home","job","visit","exam","dinner","birthday","food","car","grade","test","money","lunch","pizza","movie","study","project","smile","house","birthday","cat","phone","neighbor","garden","store","weather","vacation","yard","rain","book","project","trip","gift","card","coffee","tv","party","video","team","promotion","summer","smile","pizza","grade")

grid.arrange(g1.fun(1,object),g1.fun(2,object),g1.fun(3,object),g1.fun(4,object),g1.fun(5,object), nrow = 3,top="Mentioned object by age group")
```

"Game" shows up in 10-20, 30-40 and 40-50 age group. It was mentioned most in 10-20 age group and the least in 40-50 age group.

"School" shows up in first 4 age groups as well. But they might caused by different reasons. Younger one is more likely to be happy because of their own experience at school. Elder ones might be happy about their child at school.



## Gender & Parenthood
```{r echo=FALSE}
# non-parent by gender
male <- bag_of_words[gender == "m" & parenthood == "n",.N,by = .(word)][order(-N)]
male <- male[1:10]
male$word <- factor(male$word,levels=male$word[seq(10,1,-1)])
female <- bag_of_words[gender == "f" & parenthood == "n",.N,by = .(word)][order(-N)]
female <- female[1:10]
female$word <- factor(female$word,levels=female$word[seq(10,1,-1)])
g1 <- ggplot()+
  geom_bar(data=data.frame(male),mapping=aes(word,N),stat = "identity",fill="#87CEFA")+
  ggtitle("Male, non-parent")+
  coord_flip()
g2 <- ggplot()+
  geom_bar(data=data.frame(female),mapping=aes(word,N),stat ="identity",fill="#FFC0CB")+
  ggtitle("Female, non-parent")+
  coord_flip()

# parent by gender
father <- bag_of_words[gender == "m" & parenthood == "y",.N,by = .(word)][order(-N)]
father <- father[1:10]
father$word <- factor(father$word,levels=father$word[seq(10,1,-1)])
mother <- bag_of_words[gender == "f" & parenthood == "y",.N,by = .(word)][order(-N)]
mother <- mother[1:10]
mother$word <- factor(mother$word,levels=mother$word[seq(10,1,-1)])
g3 <- ggplot()+
  geom_bar(data=data.frame(father),mapping=aes(word,N),stat = "identity",fill="#87CEFA")+
  ggtitle("Father")+
  coord_flip()
g4 <- ggplot()+
  geom_bar(data=data.frame(mother),mapping=aes(word,N),stat ="identity",fill="#FFC0CB")+
  ggtitle("Mother")+
  coord_flip()

grid.arrange(g1,g2,g3,g4, nrow = 2,top="Mentioned words by gender and parenthood")
```

From above plot, we can see that work is the top mentioned word by male. "Father" tend to mentioned more "work" that non-parent males.

For females, son, husband and daughter are the top mentioned words by "mother". They are mentioned more times than "work".


__Explanation:__

$*^1$: Although there are some data as small as 3 and as large as 233. These data are considered invalid data and therefore not included in the groups.

$*^2$: Words of different topics are manually selected from the "bag_of_words" data.

Here are a few example of the list:

Person:
```{r echo=FALSE}
head(person)
```

Verb:
```{r echo=FALSE}
head(verb)
```


Object:
```{r echo=FALSE}
head(object)
```

